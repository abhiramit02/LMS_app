<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Performance Analytics - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; margin: 10px 0; }
        .risk-critical { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
        .risk-high { background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%); }
        .risk-medium { background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%); }
        .risk-low { background: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%); }
        .student-card { border-radius: 10px; margin: 10px 0; padding: 15px; border-left: 5px solid; cursor: pointer; }
        .student-card.critical { border-left-color: #e74c3c; background-color: #fdf2f2; }
        .student-card.high { border-left-color: #f39c12; background-color: #fef9e7; }
        .student-card.medium { border-left-color: #3498db; background-color: #ebf3fd; }
        .student-card.low { border-left-color: #27ae60; background-color: #eafaf1; }
        .metric-badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; margin: 2px; }
        .chart-container { position: relative; height: 300px; margin: 20px 0; background: white; border-radius: 10px; padding: 20px; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link text-white" href="/"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="/ui/assignments"><i class="fas fa-file-alt"></i> Assignments</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="/ui/plagiarism"><i class="fas fa-search"></i> Plagiarism Checker</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="/ui/recommendations"><i class="fas fa-lightbulb"></i> Recommendations</a></li>
                    <li class="nav-item"><a class="nav-link text-white active" href="/ui/analytics"><i class="fas fa-chart-line"></i> Performance Analytics</a></li>
                </ul>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2"><i class="fas fa-chart-line text-primary"></i> Student Performance Analytics</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button class="btn btn-outline-secondary me-2" onclick="refreshAnalytics()"><i class="fas fa-sync-alt"></i> Refresh</button>
                    <button class="btn btn-outline-primary" onclick="exportReport()"><i class="fas fa-download"></i> Export Report</button>
                </div>
            </div>

            <div id="loading-spinner" class="text-center" style="display: none;">
                <div class="spinner-border text-primary" role="status"></div>
                <p>Loading analytics data...</p>
            </div>

            <div id="overview-section" class="row mb-4" style="display: none;">
                <div class="col-md-3"><div class="analytics-card"><h4 id="total-students">0</h4><p class="mb-0"><i class="fas fa-users"></i> Total Students</p></div></div>
                <div class="col-md-3"><div class="analytics-card risk-critical"><h4 id="critical-risk">0</h4><p class="mb-0"><i class="fas fa-exclamation-triangle"></i> Critical Risk</p></div></div>
                <div class="col-md-3"><div class="analytics-card risk-high"><h4 id="high-risk">0</h4><p class="mb-0"><i class="fas fa-exclamation-circle"></i> High Risk</p></div></div>
                <div class="col-md-3"><div class="analytics-card risk-low"><h4 id="improvement-rate">0%</h4><p class="mb-0"><i class="fas fa-arrow-up"></i> Improvement Rate</p></div></div>
            </div>

            <div id="charts-section" class="row mb-4" style="display: none;">
                <div class="col-md-6"><div class="chart-container"><h5>Risk Distribution</h5><canvas id="riskChart"></canvas></div></div>
                <div class="col-md-6"><div class="chart-container"><h5>Performance Distribution</h5><canvas id="performanceChart"></canvas></div></div>
            </div>

            <div id="at-risk-section" class="card mb-4" style="display: none;">
                <div class="card-header"><h5><i class="fas fa-exclamation-triangle text-danger"></i> Students Requiring Immediate Attention</h5></div>
                <div class="card-body"><div id="priority-students"></div></div>
            </div>

            <div id="students-section" class="card mb-4" style="display: none;">
                <div class="card-header"><h5><i class="fas fa-users"></i> All Students Performance</h5></div>
                <div class="card-body"><div id="all-students"></div></div>
            </div>

            <div class="modal fade" id="studentModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-user"></i> Student Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body"><div id="student-details"></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let analyticsData = {};

document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
});

async function loadAnalytics() {
    document.getElementById('loading-spinner').style.display = 'block';
    
    try {
        const response = await fetch('/analytics/overview');
        const data = await response.json();
        
        if (response.ok) {
            analyticsData = data;
            displayAnalytics(data);
        } else {
            alert('Failed to load analytics: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    } finally {
        document.getElementById('loading-spinner').style.display = 'none';
    }
}

function displayAnalytics(data) {
    document.getElementById('total-students').textContent = data.overview.total_students;
    document.getElementById('critical-risk').textContent = data.total_critical_risk;
    document.getElementById('high-risk').textContent = data.total_high_risk;
    document.getElementById('improvement-rate').textContent = data.improvement_rate.toFixed(1) + '%';
    
    document.getElementById('overview-section').style.display = 'block';
    document.getElementById('charts-section').style.display = 'block';
    document.getElementById('at-risk-section').style.display = 'block';
    document.getElementById('students-section').style.display = 'block';
    
    createCharts(data);
    displayPriorityStudents(data.at_risk_students);
    displayAllStudents(data.all_students || {});
}

function createCharts(data) {
    const riskCtx = document.getElementById('riskChart').getContext('2d');
    new Chart(riskCtx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [data.overview.risk_distribution.critical, data.overview.risk_distribution.high, data.overview.risk_distribution.medium, data.overview.risk_distribution.low],
                backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#27ae60']
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    const perfCtx = document.getElementById('performanceChart').getContext('2d');
    new Chart(perfCtx, {
        type: 'bar',
        data: {
            labels: ['Excellent', 'Good', 'Average', 'Struggling'],
            datasets: [{
                data: [data.overview.performance_distribution.excellent, data.overview.performance_distribution.good, data.overview.performance_distribution.average, data.overview.performance_distribution.struggling],
                backgroundColor: ['#27ae60', '#3498db', '#f39c12', '#e74c3c']
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
}

function displayPriorityStudents(atRiskData) {
    const container = document.getElementById('priority-students');
    const priorityStudents = [...(atRiskData.critical || []), ...(atRiskData.high || [])];
    
    if (priorityStudents.length === 0) {
        container.innerHTML = '<div class="alert alert-success">No students requiring immediate attention!</div>';
        return;
    }

    let html = '';
    priorityStudents.forEach(student => {
        const riskClass = student.risk_score <= 0.3 ? 'critical' : 'high';
        html += `
            <div class="student-card ${riskClass}" onclick="showStudentDetails('${student.student_id}')">
                <div class="row">
                    <div class="col-md-3"><h6>${student.student_id.toUpperCase()}</h6><span class="metric-badge">${student.avg_score.toFixed(1)}/20</span></div>
                    <div class="col-md-3">Completion: ${(student.completion_rate * 100).toFixed(1)}%</div>
                    <div class="col-md-3">Engagement: ${student.engagement_level}</div>
                    <div class="col-md-3">Issues: ${student.main_issues.slice(0, 2).join(', ')}</div>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function displayAllStudents(studentsData) {
    const container = document.getElementById('all-students');
    const students = Object.values(studentsData);
    
    if (students.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No student data available.</div>';
        return;
    }

    let html = '';
    students.forEach(student => {
        html += `
            <div class="student-card ${student.risk_level}" onclick="showStudentDetails('${student.student_id}')">
                <div class="row">
                    <div class="col-md-2"><h6>${student.student_id.toUpperCase()}</h6><span class="metric-badge">${student.performance_category}</span></div>
                    <div class="col-md-2">Score: ${student.avg_score.toFixed(1)}/20</div>
                    <div class="col-md-2">Completion: ${(student.completion_rate * 100).toFixed(1)}%</div>
                    <div class="col-md-2">Time: ${student.total_time_spent.toFixed(0)}min</div>
                    <div class="col-md-2">Engagement: ${student.engagement_level}</div>
                    <div class="col-md-2">Risk: ${student.risk_level}</div>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

async function showStudentDetails(studentId) {
    try {
        const response = await fetch(`/analytics/student/${studentId}`);
        const data = await response.json();
        
        if (response.ok) {
            const student = data.student_metrics;
            const recommendations = data.recommendations;
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Performance Metrics</h6>
                        <p>Average Score: <strong>${student.avg_score.toFixed(1)}/20</strong></p>
                        <p>Completion Rate: <strong>${(student.completion_rate * 100).toFixed(1)}%</strong></p>
                        <p>Time Spent: <strong>${student.total_time_spent.toFixed(0)} minutes</strong></p>
                        <p>Risk Level: <span class="badge bg-danger">${student.risk_level.toUpperCase()}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Recommendations</h6>
                        <strong>Priority Actions:</strong>
                        <ul>${(recommendations.priority_actions || []).map(action => `<li>${action}</li>`).join('')}</ul>
                        <strong>Study Tips:</strong>
                        <ul>${(recommendations.study_tips || []).slice(0, 3).map(tip => `<li>${tip}</li>`).join('')}</ul>
                    </div>
                </div>
            `;
            
            document.getElementById('student-details').innerHTML = html;
            new bootstrap.Modal(document.getElementById('studentModal')).show();
        }
    } catch (error) {
        alert('Failed to load student details: ' + error.message);
    }
}

async function refreshAnalytics() {
    await fetch('/analytics/refresh-analytics', { method: 'POST' });
    loadAnalytics();
}

async function exportReport() {
    try {
        const response = await fetch('/analytics/export-report');
        const data = await response.json();
        alert(response.ok ? 'Report exported successfully!' : 'Failed to export report');
    } catch (error) {
        alert('Failed to export report: ' + error.message);
    }
}
</script>
</body>
</html>
