<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plagiarism Checker - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .plagiarism-alert { border-radius: 10px; padding: 20px; margin: 20px 0; border-left: 5px solid; }
        .alert-critical { background-color: #ffe6e6; border-color: #dc3545; color: #721c24; }
        .alert-high { background-color: #fff3cd; border-color: #ffc107; color: #856404; }
        .alert-medium { background-color: #e7f3ff; border-color: #17a2b8; color: #0c5460; }
        .alert-low { background-color: #f8f9fa; border-color: #6c757d; color: #495057; }
        .alert-none { background-color: #d4edda; border-color: #28a745; color: #155724; }
        .similarity-bar { height: 25px; border-radius: 15px; background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%); position: relative; margin: 10px 0; }
        .similarity-indicator { position: absolute; top: -5px; width: 20px; height: 35px; background: #343a40; border-radius: 10px; transform: translateX(-50%); }
        .upload-area { border: 2px dashed #dee2e6; border-radius: 10px; padding: 40px; text-align: center; transition: all 0.3s ease; cursor: pointer; }
        .upload-area:hover { border-color: #007bff; background-color: #f8f9fa; }
        .upload-area.dragover { border-color: #007bff; background-color: #e3f2fd; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; margin: 10px 0; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link text-white" href="/"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="/ui/assignments"><i class="fas fa-file-alt"></i> Assignments</a></li>
                    <li class="nav-item"><a class="nav-link text-white active" href="/ui/plagiarism"><i class="fas fa-search"></i> Plagiarism Checker</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="/ui/recommendations"><i class="fas fa-lightbulb"></i> Recommendations</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2"><i class="fas fa-search text-primary"></i> Plagiarism Checker</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button class="btn btn-outline-secondary" onclick="refreshStats()"><i class="fas fa-sync-alt"></i> Refresh Stats</button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3"><div class="stats-card"><h4 id="total-assignments">0</h4><p class="mb-0">Total Assignments</p></div></div>
                <div class="col-md-3"><div class="stats-card"><h4 id="checked-today">0</h4><p class="mb-0">Checked Today</p></div></div>
                <div class="col-md-3"><div class="stats-card"><h4 id="plagiarism-rate">0%</h4><p class="mb-0">Plagiarism Rate</p></div></div>
                <div class="col-md-3"><div class="stats-card"><h4 id="avg-similarity">0%</h4><p class="mb-0">Avg Similarity</p></div></div>
            </div>

            <!-- Upload Section -->
            <div class="card mb-4">
                <div class="card-header"><h5><i class="fas fa-upload"></i> Check Assignment for Plagiarism</h5></div>
                <div class="card-body">
                    <form id="plagiarism-form" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6"><div class="mb-3"><label for="student-id" class="form-label">Student ID</label><input type="text" class="form-control" id="student-id" name="student_id" required></div></div>
                            <div class="col-md-6"><div class="mb-3"><label for="assignment-title" class="form-label">Assignment Title</label><input type="text" class="form-control" id="assignment-title" name="assignment_title" required></div></div>
                        </div>
                        <div class="upload-area" id="upload-area">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Drag & Drop your assignment file here</h5>
                            <p class="text-muted">or click to browse</p>
                            <input type="file" id="assignment-file" name="file" accept=".pdf,.docx,.txt" style="display: none;" required>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('assignment-file').click()"><i class="fas fa-folder-open"></i> Choose File</button>
                        </div>
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-primary btn-lg" id="check-btn"><i class="fas fa-search"></i> Check for Plagiarism</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" style="display: none;">
                <div class="card">
                    <div class="card-header"><h5><i class="fas fa-chart-bar"></i> Plagiarism Analysis Results</h5></div>
                    <div class="card-body">
                        <div id="plagiarism-alert"></div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Similarity Score</h6>
                                <div class="similarity-bar"><div class="similarity-indicator" id="similarity-indicator"></div></div>
                                <div class="text-center"><span id="similarity-percentage" class="h4"></span></div>
                            </div>
                            <div class="col-md-6">
                                <h6>Severity Level</h6>
                                <div id="severity-badge" class="badge fs-6 p-3"></div>
                            </div>
                        </div>
                        <div id="detailed-comparisons" class="mt-4"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Checks -->
            <div class="card mt-4">
                <div class="card-header"><h5><i class="fas fa-history"></i> Recent Plagiarism Checks</h5></div>
                <div class="card-body">
                    <div id="recent-checks"><p class="text-muted">No recent checks to display.</p></div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('assignment-file');
const form = document.getElementById('plagiarism-form');
const resultsSection = document.getElementById('results-section');

// Drag & Drop
uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
uploadArea.addEventListener('drop', e => {
    e.preventDefault(); uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) { fileInput.files = files; updateFileDisplay(files[0]); }
});
fileInput.addEventListener('change', e => { if (e.target.files.length > 0) updateFileDisplay(e.target.files[0]); });
function updateFileDisplay(file) {
    uploadArea.innerHTML = `
        <i class="fas fa-file-alt fa-3x text-success mb-3"></i>
        <h5>${file.name}</h5>
        <p class="text-muted">Size: ${(file.size/1024).toFixed(2)} KB</p>
        <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('assignment-file').click()">
            <i class="fas fa-edit"></i> Change File
        </button>
    `;
}

// Form Submit
form.addEventListener('submit', async e => {
    e.preventDefault();
    if (!fileInput.files.length) { alert("Please select a file."); return; }

    // Create FormData manually to ensure correct field names
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('student_id', document.getElementById('student-id').value);
    formData.append('assignment_title', document.getElementById('assignment-title').value);

    const checkBtn = document.getElementById('check-btn');
    checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...'; checkBtn.disabled = true;

    try {
        const response = await fetch('/plagiarism/check', { method: 'POST', body: formData });
        const result = await response.json();
        if (response.ok) { displayResults(result); addToRecentChecks(result); } 
        else { showError(result.detail || 'Plagiarism check failed'); }
    } catch (error) { showError('Network error: ' + error.message); }
    finally { checkBtn.innerHTML = '<i class="fas fa-search"></i> Check for Plagiarism'; checkBtn.disabled = false; }
});

// Display Results
function displayResults(result) {
    resultsSection.style.display = 'block';
    const alertDiv = document.getElementById('plagiarism-alert');
    const similarityIndicator = document.getElementById('similarity-indicator');
    const similarityPercentage = document.getElementById('similarity-percentage');
    const severityBadge = document.getElementById('severity-badge');
    const detailedComparisons = document.getElementById('detailed-comparisons');

    let alertClass = 'alert-none';
    if (result.severity === 'CRITICAL') alertClass = 'alert-critical';
    else if (result.severity === 'HIGH') alertClass = 'alert-high';
    else if (result.severity === 'MEDIUM') alertClass = 'alert-medium';
    else if (result.severity === 'LOW') alertClass = 'alert-low';

    alertDiv.innerHTML = `<div class="plagiarism-alert ${alertClass}">
        <h4><i class="fas fa-exclamation-triangle"></i> ${result.alert_message}</h4>
        <p class="mb-0">Checked against ${result.total_assignments_compared || 0} existing assignments</p>
    </div>`;

    similarityIndicator.style.left = `${result.plagiarism_percentage}%`;
    similarityPercentage.textContent = `${result.plagiarism_percentage.toFixed(1)}%`;

    let badgeClass = 'bg-success';
    if (result.severity === 'CRITICAL') badgeClass = 'bg-danger';
    else if (result.severity === 'HIGH') badgeClass = 'bg-warning';
    else if (result.severity === 'MEDIUM') badgeClass = 'bg-info';
    else if (result.severity === 'LOW') badgeClass = 'bg-secondary';

    severityBadge.className = `badge ${badgeClass} fs-6 p-3`; severityBadge.textContent = result.severity;

    if (result.detailed_comparisons && result.detailed_comparisons.length) {
        let html = '<h6>Detailed Comparisons:</h6><div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>Assignment</th><th>Student</th><th>Text Similarity</th><th>Semantic Similarity</th><th>Overall</th></tr></thead><tbody>';
        result.detailed_comparisons.forEach(c => {
            html += `<tr><td>${c.assignment_title}</td><td>${c.student_name}</td>
            <td>${(c.text_similarity*100).toFixed(1)}%</td>
            <td>${(c.semantic_similarity*100).toFixed(1)}%</td>
            <td>${(c.weighted_similarity*100).toFixed(1)}%</td></tr>`;
        });
        html += '</tbody></table></div>'; detailedComparisons.innerHTML = html;
    } else { detailedComparisons.innerHTML = '<p class="text-muted">No significant similarities found.</p>'; }
}

function showError(message) {
    resultsSection.style.display = 'block';
    document.getElementById('plagiarism-alert').innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> ${message}</div>`;
}

function addToRecentChecks(result) {
    const recentChecks = document.getElementById('recent-checks');
    const checkItem = document.createElement('div'); checkItem.className = 'border-bottom pb-2 mb-2';
    checkItem.innerHTML = `<div class="d-flex justify-content-between align-items-center">
        <div><strong>${result.student_id}</strong> - ${result.assignment_title}<br><small class="text-muted">${new Date(result.timestamp).toLocaleString()}</small></div>
        <div><span class="badge ${result.plagiarism_detected ? 'bg-danger' : 'bg-success'}">${result.plagiarism_detected ? 'Plagiarism Detected' : 'Clean'}</span>
        <span class="ms-2">${result.plagiarism_percentage.toFixed(1)}%</span></div></div>`;
    if (recentChecks.querySelector('.text-muted')) recentChecks.innerHTML = '';
    recentChecks.insertBefore(checkItem, recentChecks.firstChild);
}

// Refresh Stats
async function refreshStats() {
    try {
        const response = await fetch('/plagiarism/statistics');
        const stats = await response.json();
        if (response.ok) {
            document.getElementById('total-assignments').textContent = stats.total_assignments || 0;
            document.getElementById('checked-today').textContent = stats.checked_today || 0;
            document.getElementById('plagiarism-rate').textContent = (stats.plagiarism_rate || 0) + '%';
            document.getElementById('avg-similarity').textContent = (stats.avg_similarity || 0) + '%';
        }
    } catch (error) { console.error('Failed to refresh stats:', error); }
}

// Initial load
refreshStats();
</script>
</body>
</html>
