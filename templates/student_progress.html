<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #059669;
            border-bottom: 3px solid #059669;
        }

        .nav-tab:hover {
            background: #f1f5f9;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .student-selector {
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .student-selector select {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 200px;
        }

        .student-selector select:focus {
            outline: none;
            border-color: #059669;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .metric-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #1f2937;
        }

        .metric-card p {
            color: #6b7280;
            font-weight: 500;
        }

        .metric-card.grade-a h3 { color: #059669; }
        .metric-card.grade-b h3 { color: #0ea5e9; }
        .metric-card.grade-c h3 { color: #f59e0b; }
        .metric-card.grade-d h3 { color: #f97316; }
        .metric-card.grade-f h3 { color: #ef4444; }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #1f2937;
            text-align: center;
        }

        .topic-performance {
            margin-bottom: 30px;
        }

        .topic-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topic-name {
            font-weight: 600;
            color: #1f2937;
        }

        .topic-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .accuracy-bar {
            width: 100px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .accuracy-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .accuracy-high { background: #059669; }
        .accuracy-medium { background: #f59e0b; }
        .accuracy-low { background: #ef4444; }

        .recommendations {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .recommendations h3 {
            color: #0c4a6e;
            margin-bottom: 15px;
        }

        .recommendations ul {
            list-style: none;
        }

        .recommendations li {
            background: white;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #0ea5e9;
        }

        .class-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .overview-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .overview-card h3 {
            margin-bottom: 20px;
            color: #1f2937;
            text-align: center;
        }

        .student-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8fafc;
            border-radius: 6px;
        }

        .student-item:hover {
            background: #f1f5f9;
            cursor: pointer;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #059669;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .alert.error {
            background: #fef2f2;
            border: 1px solid #dc2626;
            color: #dc2626;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .student-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .student-selector select {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Student Progress Tracker</h1>
            <p>Comprehensive performance analytics and progress visualization</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('individual')">Individual Student</button>
            <button class="nav-tab" onclick="switchTab('class')">Class Overview</button>
            <button class="nav-tab" onclick="switchTab('topics')">Topic Analysis</button>
        </div>

        <!-- Individual Student Tab -->
        <div id="individual" class="tab-content active">
            <div class="student-selector">
                <label for="studentSelect"><strong>Select Student:</strong></label>
                <select id="studentSelect">
                    <option value="">Loading students...</option>
                </select>
                <button onclick="loadStudentData()" style="padding: 10px 20px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer;">Load Data</button>
            </div>

            <div class="loading" id="studentLoading">
                <div class="spinner"></div>
                <p>Loading student data...</p>
            </div>

            <div id="studentData" style="display: none;">
                <!-- Metrics Grid -->
                <div class="metrics-grid" id="metricsGrid"></div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-container">
                        <h3>Score History</h3>
                        <canvas id="scoreChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Topic Performance</h3>
                        <canvas id="topicChart"></canvas>
                    </div>
                </div>

                <!-- Topic Performance Details -->
                <div class="topic-performance">
                    <h3>Detailed Topic Breakdown</h3>
                    <div id="topicBreakdown"></div>
                </div>

                <!-- Recommendations -->
                <div class="recommendations">
                    <h3>üí° Personalized Recommendations</h3>
                    <ul id="recommendationsList"></ul>
                </div>
            </div>
        </div>

        <!-- Class Overview Tab -->
        <div id="class" class="tab-content">
            <div class="loading" id="classLoading">
                <div class="spinner"></div>
                <p>Loading class overview...</p>
            </div>

            <div id="classData" style="display: none;">
                <div class="class-overview-grid">
                    <div class="overview-card">
                        <h3>üìà Class Statistics</h3>
                        <div id="classStats"></div>
                    </div>
                    
                    <div class="overview-card">
                        <h3>üåü Top Performers</h3>
                        <div class="student-list" id="topPerformers"></div>
                    </div>
                    
                    <div class="overview-card">
                        <h3>‚ö†Ô∏è Students Needing Support</h3>
                        <div class="student-list" id="strugglingStudents"></div>
                    </div>
                    
                    <div class="overview-card">
                        <h3>üìö Topic Difficulty Ranking</h3>
                        <div class="student-list" id="topicDifficulty"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topic Analysis Tab -->
        <div id="topics" class="tab-content">
            <div class="loading" id="topicLoading">
                <div class="spinner"></div>
                <p>Loading topic analysis...</p>
            </div>

            <div id="topicAnalysisData" style="display: none;">
                <div class="chart-container" style="margin-bottom: 30px;">
                    <h3>Topic Performance Overview</h3>
                    <canvas id="topicOverviewChart"></canvas>
                </div>
                
                <div id="topicDetailsList"></div>
            </div>
        </div>
    </div>

    <div id="alerts"></div>

    <script>
        let currentStudentData = null;
        let scoreChart = null;
        let topicChart = null;
        let topicOverviewChart = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentList();
            loadClassOverview();
            loadTopicAnalysis();
        });

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadStudentList() {
            try {
                const response = await fetch('/student-progress/students');
                const students = await response.json();
                
                const select = document.getElementById('studentSelect');
                select.innerHTML = '<option value="">Select a student...</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.student_id;
                    option.textContent = `${student.student_id} (Grade: ${student.grade}, Score: ${student.overall_score}%)`;
                    select.appendChild(option);
                });
            } catch (error) {
                showAlert('Error loading student list: ' + error.message, 'error');
            }
        }

        async function loadStudentData() {
            const studentId = document.getElementById('studentSelect').value;
            if (!studentId) {
                showAlert('Please select a student first.', 'error');
                return;
            }

            document.getElementById('studentLoading').style.display = 'block';
            document.getElementById('studentData').style.display = 'none';

            try {
                const response = await fetch(`/student-progress/student/${studentId}`);
                const data = await response.json();
                
                if (response.ok) {
                    currentStudentData = data;
                    displayStudentData(data);
                } else {
                    showAlert(data.detail || 'Error loading student data', 'error');
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'error');
            } finally {
                document.getElementById('studentLoading').style.display = 'none';
            }
        }

        function displayStudentData(data) {
            // Display metrics
            const metricsGrid = document.getElementById('metricsGrid');
            const gradeClass = `grade-${data.student_info.grade.toLowerCase()}`;
            
            metricsGrid.innerHTML = `
                <div class="metric-card ${gradeClass}">
                    <h3>${data.student_info.overall_score}%</h3>
                    <p>Overall Score</p>
                </div>
                <div class="metric-card">
                    <h3>${data.student_info.grade}</h3>
                    <p>Current Grade</p>
                </div>
                <div class="metric-card">
                    <h3>${data.student_info.accuracy_rate}%</h3>
                    <p>Accuracy Rate</p>
                </div>
                <div class="metric-card">
                    <h3>${data.student_info.total_attempts}</h3>
                    <p>Total Attempts</p>
                </div>
                <div class="metric-card">
                    <h3>${data.student_info.total_time_spent}</h3>
                    <p>Minutes Studied</p>
                </div>
                <div class="metric-card">
                    <h3>${data.student_info.topics_studied.length}</h3>
                    <p>Topics Covered</p>
                </div>
            `;

            // Display topic breakdown
            const topicBreakdown = document.getElementById('topicBreakdown');
            topicBreakdown.innerHTML = '';
            
            data.topic_breakdown.forEach(topic => {
                const accuracyClass = topic.accuracy >= 80 ? 'accuracy-high' : 
                                    topic.accuracy >= 60 ? 'accuracy-medium' : 'accuracy-low';
                
                const topicDiv = document.createElement('div');
                topicDiv.className = 'topic-item';
                topicDiv.innerHTML = `
                    <div class="topic-name">${topic.topic}</div>
                    <div class="topic-stats">
                        <span>Accuracy: ${topic.accuracy}%</span>
                        <span>Attempts: ${topic.attempts}</span>
                        <span>Time: ${topic.time_spent}min</span>
                        <div class="accuracy-bar">
                            <div class="accuracy-fill ${accuracyClass}" style="width: ${topic.accuracy}%"></div>
                        </div>
                    </div>
                `;
                topicBreakdown.appendChild(topicDiv);
            });

            // Display recommendations
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = '';
            data.recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recommendationsList.appendChild(li);
            });

            // Create charts
            createScoreChart(data.score_history);
            createTopicChart(data.topic_breakdown);

            document.getElementById('studentData').style.display = 'block';
        }

        function createScoreChart(scoreHistory) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            
            if (scoreChart) {
                scoreChart.destroy();
            }

            const labels = scoreHistory.map(score => score.date);
            const scores = scoreHistory.map(score => score.percentage);

            scoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Test Scores (%)',
                        data: scores,
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function createTopicChart(topicData) {
            const ctx = document.getElementById('topicChart').getContext('2d');
            
            if (topicChart) {
                topicChart.destroy();
            }

            const labels = topicData.map(topic => topic.topic);
            const accuracies = topicData.map(topic => topic.accuracy);

            topicChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: accuracies,
                        backgroundColor: accuracies.map(acc => 
                            acc >= 80 ? '#059669' : acc >= 60 ? '#f59e0b' : '#ef4444'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        async function loadClassOverview() {
            document.getElementById('classLoading').style.display = 'block';

            try {
                const response = await fetch('/student-progress/class-overview');
                const data = await response.json();
                
                if (response.ok) {
                    displayClassOverview(data);
                } else {
                    showAlert(data.detail || 'Error loading class overview', 'error');
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'error');
            } finally {
                document.getElementById('classLoading').style.display = 'none';
            }
        }

        function displayClassOverview(data) {
            // Class statistics
            const classStats = document.getElementById('classStats');
            classStats.innerHTML = `
                <div class="metric-card">
                    <h3>${data.total_students}</h3>
                    <p>Total Students</p>
                </div>
                <div class="metric-card">
                    <h3>${data.avg_class_performance}%</h3>
                    <p>Class Average</p>
                </div>
            `;

            // Top performers
            const topPerformers = document.getElementById('topPerformers');
            topPerformers.innerHTML = '';
            data.top_performers.forEach(student => {
                const div = document.createElement('div');
                div.className = 'student-item';
                div.innerHTML = `
                    <span>${student.student_id}</span>
                    <span>${student.overall_score}% (${student.grade})</span>
                `;
                div.onclick = () => selectStudent(student.student_id);
                topPerformers.appendChild(div);
            });

            // Struggling students
            const strugglingStudents = document.getElementById('strugglingStudents');
            strugglingStudents.innerHTML = '';
            data.struggling_students.forEach(student => {
                const div = document.createElement('div');
                div.className = 'student-item';
                div.innerHTML = `
                    <span>${student.student_id}</span>
                    <span>${student.overall_score}% (${student.grade})</span>
                `;
                div.onclick = () => selectStudent(student.student_id);
                strugglingStudents.appendChild(div);
            });

            // Topic difficulty
            const topicDifficulty = document.getElementById('topicDifficulty');
            topicDifficulty.innerHTML = '';
            data.topic_difficulty_ranking.forEach(topic => {
                const div = document.createElement('div');
                div.className = 'student-item';
                div.innerHTML = `
                    <span>${topic.topic}</span>
                    <span>${topic.class_accuracy}% accuracy</span>
                `;
                topicDifficulty.appendChild(div);
            });

            document.getElementById('classData').style.display = 'block';
        }

        async function loadTopicAnalysis() {
            document.getElementById('topicLoading').style.display = 'block';

            try {
                const response = await fetch('/student-progress/topic-analysis');
                const data = await response.json();
                
                if (response.ok) {
                    displayTopicAnalysis(data);
                } else {
                    showAlert(data.detail || 'Error loading topic analysis', 'error');
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'error');
            } finally {
                document.getElementById('topicLoading').style.display = 'none';
            }
        }

        function displayTopicAnalysis(data) {
            // Create topic overview chart
            const ctx = document.getElementById('topicOverviewChart').getContext('2d');
            
            if (topicOverviewChart) {
                topicOverviewChart.destroy();
            }

            const labels = data.map(topic => topic.topic);
            const accuracies = data.map(topic => topic.accuracy_rate);
            const testScores = data.map(topic => topic.avg_test_score);

            topicOverviewChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Practice Accuracy (%)',
                        data: accuracies,
                        backgroundColor: 'rgba(5, 150, 105, 0.7)'
                    }, {
                        label: 'Test Average (%)',
                        data: testScores,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Display topic details
            const topicDetailsList = document.getElementById('topicDetailsList');
            topicDetailsList.innerHTML = '';
            
            data.forEach(topic => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'overview-card';
                topicDiv.innerHTML = `
                    <h3>${topic.topic}</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="metric-card">
                            <h3>${topic.accuracy_rate}%</h3>
                            <p>Practice Accuracy</p>
                        </div>
                        <div class="metric-card">
                            <h3>${topic.avg_test_score}%</h3>
                            <p>Test Average</p>
                        </div>
                        <div class="metric-card">
                            <h3>${topic.students_attempted}</h3>
                            <p>Students Attempted</p>
                        </div>
                        <div class="metric-card">
                            <h3>${topic.difficulty_level}</h3>
                            <p>Difficulty Level</p>
                        </div>
                    </div>
                `;
                topicDetailsList.appendChild(topicDiv);
            });

            document.getElementById('topicAnalysisData').style.display = 'block';
        }

        function selectStudent(studentId) {
            document.getElementById('studentSelect').value = studentId;
            switchTab('individual');
            document.querySelector('.nav-tab').classList.remove('active');
            document.querySelectorAll('.nav-tab')[0].classList.add('active');
            loadStudentData();
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            document.getElementById('alerts').appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
